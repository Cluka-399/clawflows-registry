name: iran-strike-monitor
description: Monitor Polymarket Iran/Israel strike markets with multi-line term structure charts
author: cluka
version: 1.1.0

requires:
  - capability: prediction-markets
  - capability: chart-generation
  - capability: social-search

trigger:
  schedule: "*/30 * * * *"  # Every 30 minutes

config:
  alert_threshold:
    description: "Alert if any market moves more than this many percentage points"
    default: 3
  
  days_ahead:
    description: "Focus on markets resolving within this many days"
    default: 7
  
  chart_interval:
    description: "Chart time range for price history"
    default: "1d"
  
  search_osint:
    description: "Search X OSINT accounts on significant moves"
    default: true
  
  osint_accounts:
    description: "X accounts to check for OSINT"
    default: ["Osint613", "sentdefender"]
  
  multi_line_chart:
    description: "Show multiple markets on one chart (term structure)"
    default: true
  
  max_chart_series:
    description: "Maximum number of series on multi-line chart"
    default: 4

steps:
  - name: fetch-iran-markets
    capability: prediction-markets
    method: searchMarkets
    args:
      query: "iran strike"
      filters:
        - excludeKeywords: ["gaza", "lebanon", "hezbollah", "not strike"]
        - includeKeywords: ["us", "israel", "strike", "iran"]
    capture: allMarkets

  - name: filter-near-term
    action: evaluate
    expression: |
      const now = new Date();
      const filtered = allMarkets
        .map(m => {
          // Extract deadline date from question
          const match = m.question.match(/(?:by|on)\s+(\w+)\s+(\d{1,2})(?:,?\s+(\d{4}))?/i);
          if (!match) return null;
          const months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
          const month = months[match[1].toLowerCase().slice(0,3)];
          const day = parseInt(match[2]);
          const year = match[3] ? parseInt(match[3]) : 2026;
          const deadline = new Date(year, month, day);
          const daysUntil = Math.round((deadline - now) / (1000 * 60 * 60 * 24));
          return { ...m, deadline, daysUntil, label: `${match[1].slice(0,3)} ${day}` };
        })
        .filter(m => m && m.daysUntil >= 0 && m.daysUntil <= config.days_ahead)
        .sort((a, b) => a.daysUntil - b.daysUntil);
      filtered
    capture: nearTermMarkets

  - name: get-histories-for-chart
    capability: prediction-markets
    method: getPriceHistoryMulti
    args:
      markets: "${nearTermMarkets.slice(0, config.max_chart_series)}"
      interval: "${config.chart_interval}"
    capture: priceHistories

  - name: format-multiline-data
    action: evaluate
    expression: |
      const chartData = [];
      for (const market of priceHistories) {
        for (const point of market.history) {
          chartData.push({
            x: new Date(point.timestamp).toISOString().slice(5, 16).replace('T', ' '),
            y: Math.round(point.price * 1000) / 10,
            series: market.label
          });
        }
      }
      chartData
    capture: multiLineData

  - name: generate-term-structure-chart
    capability: chart-generation
    method: lineChart
    args:
      data: "${multiLineData}"
      title: "Iran Strike Markets - Term Structure"
      yTitle: "% Yes"
      yDomain: [0, 100]
      seriesField: "series"
      width: 700
      height: 350
      dark: true
    capture: chart

  - name: check-state-for-changes
    action: state
    method: compareAndUpdate
    args:
      key: "iran-monitor-prices"
      newValues: "${nearTermMarkets.reduce((acc, m) => ({...acc, [m.slug]: m.yes * 100}), {})}"
      threshold: "${config.alert_threshold}"
    capture: changes

  - name: search-osint
    condition: "changes.hasSignificant && config.search_osint"
    capability: social-search
    method: searchPosts
    args:
      query: "from:${config.osint_accounts.join(' OR from:')} Iran"
      days: 1
    capture: osintTweets

  - name: alert-significant
    condition: "changes.hasSignificant"
    action: notify
    message: |
      ðŸš¨ **Iran Strike Monitor Alert**
      
      **ðŸ“Š Significant Movement Detected:**
      ${changes.items.map(c => `â€¢ ${c.label}: ${c.old.toFixed(1)}% â†’ **${c.new.toFixed(1)}%** (${c.delta > 0 ? '+' : ''}${c.delta.toFixed(1)}pp)`).join('\n')}
      
      **ðŸ“‹ Next ${config.days_ahead} Days:**
      ${nearTermMarkets.slice(0, 6).map(m => `â€¢ **${(m.yes * 100).toFixed(1)}%** ${m.label} (${m.daysUntil === 0 ? 'TODAY' : m.daysUntil === 1 ? 'TOMORROW' : m.daysUntil + ' days'})`).join('\n')}
      
      ${osintTweets ? `**ðŸ” X OSINT:**\n${osintTweets.slice(0, 3).map(t => `â€¢ @${t.username}: ${t.content.slice(0, 120)}...`).join('\n')}` : ''}
    attachments: ["${chart.path}"]

  - name: regular-update
    condition: "!changes.hasSignificant"
    action: log
    message: "No significant changes. Top market: ${nearTermMarkets[0]?.question || 'none'} at ${nearTermMarkets[0] ? (nearTermMarkets[0].yes * 100).toFixed(1) + '%' : 'N/A'}"
