# Lobster workflow: git-branch-cleaner
# Identify stale and merged branches that can be cleaned up
#
# Usage:
#   lobster run --file workflow.yaml --args-json '{"repo":"owner/repo"}'
#
# Requires: jq, curl
# Env: GITHUB_TOKEN (optional, for private repos / higher rate limits)

name: git-branch-cleaner
description: Identify stale and merged git branches via GitHub API

args:
  repo:
    description: "GitHub repo (owner/repo format)"
    default: "nodejs/node"
  stale_days:
    description: "Days without commits to consider stale"
    default: "30"
  exclude_branches:
    description: "Comma-separated branches to never suggest deleting"
    default: "main,master,develop,staging,production"
  max_branches:
    description: "Max branches to analyze (to limit API calls)"
    default: "30"

steps:
  - id: fetch-branches
    command: |
      # Get first page of branches only (for performance)
      curl -sf \
        -H "Accept: application/vnd.github+json" \
        ${GITHUB_TOKEN:+-H "Authorization: Bearer $GITHUB_TOKEN"} \
        "https://api.github.com/repos/${repo}/branches?per_page=${max_branches}" 2>/dev/null || echo '[]'

  - id: get-default-branch
    command: |
      curl -sf \
        -H "Accept: application/vnd.github+json" \
        ${GITHUB_TOKEN:+-H "Authorization: Bearer $GITHUB_TOKEN"} \
        "https://api.github.com/repos/${repo}" \
        2>/dev/null | jq -r '.default_branch // "main"'

  - id: analyze-branches
    stdin: $fetch-branches.stdout
    command: |
      cat > /tmp/lb_branches.json
      default_branch=$($get-default-branch.stdout 2>/dev/null || echo main)
      default_branch=$(echo "${default_branch}" | tr -d '\n' | xargs)
      [ -z "$default_branch" ] && default_branch="main"
      stale_days=${stale_days}
      exclude="${exclude_branches}"
      repo="${repo}"
      cutoff_ts=$(( $(date +%s) - stale_days * 86400 ))

      # Analyze branches - simplified: only check first few branches
      tmpout=$(mktemp)
      echo '[]' > "$tmpout"
      
      branches=$(jq -r '.[].name' /tmp/lb_branches.json | head -20)

      for branch in $branches; do
        # Skip excluded
        if echo ",$exclude," | grep -q ",$branch,"; then continue; fi
        # Skip default
        if [ "$branch" = "$default_branch" ]; then continue; fi
        
        # Get branch info with commit date
        info=$(curl -sf \
          -H "Accept: application/vnd.github+json" \
          ${GITHUB_TOKEN:+-H "Authorization: Bearer $GITHUB_TOKEN"} \
          "https://api.github.com/repos/$repo/branches/$branch" 2>/dev/null || echo '{}')
        echo "$info" > /tmp/lb_brinfo.json
        
        commit_date=$(jq -r '.commit.commit.committer.date // ""' /tmp/lb_brinfo.json)
        [ -z "$commit_date" ] && continue
        
        # Parse commit timestamp
        commit_ts=$(date -d "$commit_date" +%s 2>/dev/null || echo 0)
        is_stale="false"
        [ "$commit_ts" -lt "$cutoff_ts" ] 2>/dev/null && is_stale="true"

        # Append to results
        echo "$results" | jq -c --arg b "$branch" --arg d "$commit_date" --arg s "$is_stale" \
          '. + [{name:$b, last_commit:$d, stale:($s=="true")}]' "$tmpout" > /tmp/lb_brout.json
        mv /tmp/lb_brout.json "$tmpout"
      done

      cat "$tmpout"
      rm -f "$tmpout" /tmp/lb_branches.json /tmp/lb_brinfo.json

  - id: report
    stdin: $analyze-branches.stdout
    command: |
      cat > /tmp/lb_branalysis.json
      stale_days=${stale_days}
      
      total=$(jq 'length' /tmp/lb_branalysis.json)
      stale_count=$(jq '[.[] | select(.stale==true)] | length' /tmp/lb_branalysis.json)
      fresh_count=$(( total - stale_count ))

      echo "ðŸŒ¿ Git Branch Cleanup Report for ${repo}"
      echo ""
      if [ "$stale_count" != "0" ]; then
        echo "â° Stale branches (>${stale_days} days, not merged): $stale_count"
        jq -r '.[] | select(.stale==true) | "  â€¢ \(.name) (last commit: \(.last_commit | split("T")[0]))"' /tmp/lb_branalysis.json
        echo ""
      fi
      if [ "$fresh_count" != "0" ]; then
        echo "âœ… Active branches (recent commits): $fresh_count"
      fi
      if [ "$total" = "0" ]; then
        echo "âœ¨ No non-default branches found to analyze."
      fi
      echo "ðŸ“Š $total branches analyzed (excluding excluded list and default branch)"
      rm -f /tmp/lb_branalysis.json
