# Lobster workflow: sleep-schedule-optimizer
# Analyzes sleep log data and calendar to suggest optimal bedtimes
#
# Usage:
#   lobster run --file workflow.yaml --args-json '{"sleep_log":"/path/to/sleep.json","calendar_cmd":"gcalcli agenda --nocolor tomorrow"}'
#
# sleep.json format: [{"date":"2026-02-01","bed":"23:30","wake":"07:15","quality":4}]
# quality: 1-5 scale
#
# Requires: jq

name: sleep-schedule-optimizer
description: Analyze sleep patterns and suggest optimal bedtimes based on calendar

args:
  sleep_log:
    description: "Path to sleep log JSON file"
    default: "/tmp/clawflows-sleep-log.json"
  calendar_cmd:
    description: "Shell command to fetch tomorrow's calendar (or empty to skip)"
    default: ""
  days:
    description: "Number of recent days to analyze"
    default: "14"

steps:
  - id: ensure-log
    command: |
      if [ ! -f "${sleep_log}" ]; then
        echo '[{"date":"2026-02-01","bed":"23:30","wake":"07:15","quality":4},{"date":"2026-02-02","bed":"00:15","wake":"07:45","quality":3},{"date":"2026-02-03","bed":"23:00","wake":"06:50","quality":5}]' > "${sleep_log}"
        echo "Created sample sleep log at ${sleep_log}"
      else
        echo "Using existing sleep log at ${sleep_log}"
      fi

  - id: load-sleep-data
    command: |
      jq -c --argjson n ${days} '
        sort_by(.date) | .[-$n:] |
        map(
          (.bed | split(":") | (.[0]|tonumber)*60 + (.[1]|tonumber)) as $bed_min |
          (.wake | split(":") | (.[0]|tonumber)*60 + (.[1]|tonumber)) as $wake_min |
          (if $bed_min > $wake_min then (1440 - $bed_min + $wake_min) else ($wake_min - $bed_min) end) as $dur |
          . + {sleep_minutes: $dur, bed_minutes: $bed_min, wake_minutes: $wake_min}
        )
      ' "${sleep_log}" > /tmp/lb_sleep_enriched.json
      cat /tmp/lb_sleep_enriched.json

  - id: compute-stats
    stdin: $load-sleep-data.stdout
    command: |
      cat > /tmp/lb_sleep_in.json
      jq '{
        total_nights: length,
        avg_sleep_hrs: ([.[].sleep_minutes] | add / length / 60 * 10 | round / 10),
        avg_quality: ([.[].quality] | add / length * 10 | round / 10),
        avg_bed_time: (([.[].bed_minutes] | add / length) | floor | "\(. / 60 | floor):\(. % 60 | tostring | if length < 2 then "0"+. else . end)"),
        avg_wake_time: (([.[].wake_minutes] | add / length) | floor | "\(. / 60 | floor):\(. % 60 | tostring | if length < 2 then "0"+. else . end)"),
        best_quality_nights: [.[] | select(.quality >= 4) | {date, bed, wake, sleep_hrs: (.sleep_minutes / 60 * 10 | round / 10)}],
        worst_quality_nights: [.[] | select(.quality <= 2) | {date, bed, wake, sleep_hrs: (.sleep_minutes / 60 * 10 | round / 10)}],
        consistency_score: (([.[].bed_minutes] | (max - min)) | if . < 60 then "good" elif . < 120 then "fair" else "poor" end)
      }' /tmp/lb_sleep_in.json > /tmp/lb_sleep_stats.json
      cat /tmp/lb_sleep_stats.json
      rm -f /tmp/lb_sleep_in.json

  - id: fetch-calendar
    command: |
      if [ -n "${calendar_cmd}" ]; then
        eval "${calendar_cmd}" 2>/dev/null || echo "Calendar fetch failed"
      else
        echo "No calendar command configured - skipping"
      fi

  - id: llm_recommend
    command: |
      STATS=$(cat /tmp/lb_sleep_stats.json)
      CAL='$fetch-calendar.stdout'
      llm_task.invoke <<PROMPT
      You are a sleep science expert. Given this sleep data and tomorrow's calendar:

      Sleep stats: $STATS
      Tomorrow's schedule: $CAL

      Provide:
      - optimal_bedtime: recommended bedtime tonight (considering tomorrow's first event)
      - optimal_wake: recommended wake time
      - sleep_target_hrs: ideal hours based on their patterns
      - pattern_insights: what patterns correlate with their best/worst sleep
      - consistency_tips: 2-3 specific tips to improve bedtime consistency
      - tonight_note: any special consideration for tonight (early meeting, etc.)

      Return JSON with those fields.
      PROMPT
    env:
      CLAWD_URL: "http://localhost:1691"

  - id: report
    stdin: $compute-stats.stdout
    command: |
      cat > /tmp/lb_stats.json
      REC='$llm_recommend.stdout'
      jq -r '
        "ğŸ›ï¸ Sleep Schedule Analysis (last \(.total_nights) nights)\n" +
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
        "â€¢ Average sleep: \(.avg_sleep_hrs)h\n" +
        "â€¢ Average quality: \(.avg_quality)/5\n" +
        "â€¢ Average bedtime: \(.avg_bed_time)\n" +
        "â€¢ Average wake time: \(.avg_wake_time)\n" +
        "â€¢ Bedtime consistency: \(.consistency_score)\n" +
        "\nğŸ“Š Best nights (quality â‰¥ 4):\n" +
        (.best_quality_nights | map("  \(.date): bed \(.bed), wake \(.wake) (\(.sleep_hrs)h)") | join("\n")) +
        if (.worst_quality_nights | length) > 0 then
          "\n\nâš ï¸ Worst nights (quality â‰¤ 2):\n" +
          (.worst_quality_nights | map("  \(.date): bed \(.bed), wake \(.wake) (\(.sleep_hrs)h)") | join("\n"))
        else "" end
      ' /tmp/lb_stats.json
      echo ""
      echo "ğŸ¤– AI Sleep Recommendations:"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "$REC" | jq -r '
        "ğŸŒ™ Optimal bedtime: \(.optimal_bedtime)\n" +
        "â° Optimal wake time: \(.optimal_wake)\n" +
        "ğŸ’¤ Sleep target: \(.sleep_target_hrs)h\n" +
        "\nğŸ“ˆ Pattern insights:\n\(.pattern_insights)\n" +
        "\nâœ… Consistency tips:\n\(.consistency_tips | if type == "array" then map("  â€¢ " + .) | join("\n") else . end)\n" +
        "\nğŸ“ Tonight: \(.tonight_note)"
      '
      rm -f /tmp/lb_stats.json
