name: focus-time-report
description: Track and report on your deep work vs fragmented time
author: cluka
version: 1.0.0

requires:
  - capability: calendar
  - capability: llm-analysis
  - capability: notifications

trigger:
  schedule: "0 18 * * 5"  # Friday 6pm

config:
  min_focus_block:
    description: "Minimum minutes for a focus block"
    default: 60
  
  target_focus_hours:
    description: "Weekly target for focus time"
    default: 20

steps:
  - name: get-week-calendar
    capability: calendar
    method: getEvents
    args:
      daysBack: 7
    capture: weekEvents

  - name: analyze-time
    action: evaluate
    expression: |
      // Find gaps between meetings (potential focus time)
      const events = weekEvents.sort((a, b) => new Date(a.start) - new Date(b.start));
      const focusBlocks = [];
      let totalMeetingMins = 0;
      
      for (let i = 0; i < events.length - 1; i++) {
        const gapMins = (new Date(events[i + 1].start) - new Date(events[i].end)) / 60000;
        if (gapMins >= config.min_focus_block) {
          focusBlocks.push({ start: events[i].end, duration: gapMins });
        }
        totalMeetingMins += (new Date(events[i].end) - new Date(events[i].start)) / 60000;
      }
      
      const totalFocusMins = focusBlocks.reduce((sum, b) => sum + b.duration, 0);
      const focusHours = Math.round(totalFocusMins / 60 * 10) / 10;
      const meetingHours = Math.round(totalMeetingMins / 60 * 10) / 10;
      const targetMet = focusHours >= config.target_focus_hours;
      
      ({ focusHours, meetingHours, focusBlocks: focusBlocks.length, targetMet, target: config.target_focus_hours })
    capture: analysis

  - name: generate-insights
    capability: llm-analysis
    method: analyze
    args:
      data: "${analysis}"
      calendar: "${weekEvents}"
      prompt: |
        Analyze this week's time usage:
        - Focus time: ${analysis.focusHours}h (target: ${analysis.target}h)
        - Meeting time: ${analysis.meetingHours}h
        
        Provide:
        1. Was the week well-balanced?
        2. Which days had the most/least focus time?
        3. Any patterns (e.g., meetings clustered, fragmented afternoons)?
        4. One suggestion for next week
    capture: insights

  - name: notify-report
    action: notify
    message: |
      ‚è±Ô∏è **Weekly Focus Report**
      
      **üìä Time Breakdown:**
      ‚Ä¢ Focus time: **${analysis.focusHours}h** ${analysis.targetMet ? '‚úÖ' : '‚ùå'} (target: ${analysis.target}h)
      ‚Ä¢ Meeting time: **${analysis.meetingHours}h**
      ‚Ä¢ Focus blocks (‚â•${config.min_focus_block}min): **${analysis.focusBlocks}**
      
      **üí° Insights:**
      ${insights}
