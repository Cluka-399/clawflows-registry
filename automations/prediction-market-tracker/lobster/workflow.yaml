# Lobster workflow: prediction-market-tracker
# Monitor Polymarket prediction markets by topic keywords, alert on significant moves
#
# Usage:
#   lobster run --file workflow.yaml
#   lobster run --file workflow.yaml --args-json '{"keywords":"iran,strike","alert_threshold":"3"}'
#
# Requires: curl, node
#
# APIs used:
#   - gamma-api.polymarket.com (Polymarket markets, no auth needed)

name: prediction-market-tracker
description: Monitor Polymarket prediction markets by topic, alert on significant probability changes

args:
  keywords:
    description: "Comma-separated keywords to filter markets (case-insensitive, matches any)"
    default: "strike,attack,military,war"
  exclude_keywords:
    description: "Comma-separated keywords to exclude markets"
    default: ""
  alert_threshold:
    description: "Alert if probability changes more than this percentage since last check"
    default: "3"
  state_file:
    description: "Path to state file for tracking last known probabilities"
    default: "/tmp/clawflows-prediction-market-state.json"
  chart_output:
    description: "Path for generated chart image"
    default: "/tmp/prediction-market-chart.png"
  chart_title:
    description: "Title for the chart"
    default: "Prediction Markets â€” Polymarket"
  osint_query:
    description: "Optional X/Twitter search query for cross-referencing (empty = skip)"
    default: ""
  osint_script:
    description: "Path to X search script"
    default: "/data/skills/search-x/scripts/search.js"
  chart_script:
    description: "Path to chart-image script"
    default: "/data/clawd/skills/chart-image/scripts/chart.mjs"

steps:
  - id: fetch-markets
    command: |
      tmpf=$(mktemp)
      curl -sf --max-time 20 \
        "https://gamma-api.polymarket.com/markets?active=true&closed=false&limit=200&order=volume24hr&ascending=false" \
        -o "$tmpf" 2>/dev/null
      if [ -s "$tmpf" ]; then
        cat "$tmpf"
      else
        echo '[]'
      fi
      rm -f "$tmpf"

  - id: filter-markets
    stdin: $fetch-markets.stdout
    command: |
      cat > /tmp/lb_pm_raw.json
      KW="${keywords}"
      EX="${exclude_keywords}"
      
      node -e "
        const fs = require('fs');
        const data = JSON.parse(fs.readFileSync('/tmp/lb_pm_raw.json', 'utf8'));
        const include = '$KW'.toLowerCase().split(',').map(s => s.trim()).filter(Boolean);
        const exclude = '$EX' ? '$EX'.toLowerCase().split(',').map(s => s.trim()).filter(Boolean) : [];

        const results = data.filter(m => {
          const q = (m.question || '').toLowerCase();
          const matchesInclude = include.some(kw => new RegExp('\\\\b' + kw + '\\\\b').test(q));
          const matchesExclude = exclude.length > 0 && exclude.some(kw => new RegExp('\\\\b' + kw + '\\\\b').test(q));
          return matchesInclude && !matchesExclude;
        }).map(m => {
          const prices = JSON.parse(m.outcomePrices || '[]');
          const yesPct = Math.round(parseFloat(prices[0] || 0) * 10000) / 100;
          return {
            question: m.question,
            yes_pct: yesPct,
            volume: m.volumeNum || 0,
            slug: m.slug
          };
        }).sort((a, b) => b.yes_pct - a.yes_pct);

        console.log(JSON.stringify(results));
      "
      rm -f /tmp/lb_pm_raw.json

  - id: load-state
    command: |
      cat "${state_file}" 2>/dev/null || echo '{}'

  - id: analyze
    command: |
      cat > /tmp/lb_markets.json << 'MARKETS_EOF'
      $filter-markets.stdout
      MARKETS_EOF
      
      cat > /tmp/lb_state.json << 'STATE_EOF'
      $load-state.stdout
      STATE_EOF
      
      THRESH="${alert_threshold}"

      node -e "
        const fs = require('fs');
        const markets = JSON.parse(fs.readFileSync('/tmp/lb_markets.json', 'utf8').trim());
        const state = JSON.parse(fs.readFileSync('/tmp/lb_state.json', 'utf8').trim());
        const thresh = parseFloat('$THRESH' || '3');

        const analyzed = markets.map(m => {
          const lastPct = state[m.slug]?.yes_pct;
          const delta = lastPct != null ? m.yes_pct - lastPct : null;
          return {
            ...m,
            last_pct: lastPct || 0,
            delta: delta || 0,
            significant: delta != null && Math.abs(delta) >= thresh,
            first_run: lastPct == null
          };
        });

        const result = {
          markets: analyzed,
          any_significant: analyzed.some(m => m.significant),
          significant_count: analyzed.filter(m => m.significant).length,
          total_count: analyzed.length,
          threshold: thresh
        };
        console.log(JSON.stringify(result));
      "
      rm -f /tmp/lb_markets.json /tmp/lb_state.json

  - id: save-state
    command: |
      cat > /tmp/lb_analysis.json << 'ANALYSIS_EOF'
      $analyze.stdout
      ANALYSIS_EOF
      
      STATE_FILE="${state_file}"

      node -e "
        const fs = require('fs');
        const analysis = JSON.parse(fs.readFileSync('/tmp/lb_analysis.json', 'utf8').trim());
        const now = new Date().toISOString();
        const state = {};
        (analysis.markets || []).forEach(m => {
          state[m.slug] = { yes_pct: m.yes_pct, updated: now };
        });
        fs.writeFileSync('$STATE_FILE', JSON.stringify(state, null, 2));
        console.log(JSON.stringify(analysis));
      "
      rm -f /tmp/lb_analysis.json

  - id: generate-chart
    command: |
      cat > /tmp/lb_chart_analysis.json << 'ANALYSIS_EOF'
      $save-state.stdout
      ANALYSIS_EOF
      
      CHART_SCRIPT="${chart_script}"
      CHART_OUTPUT="${chart_output}"
      CHART_TITLE="${chart_title}"

      if [ ! -f "$CHART_SCRIPT" ]; then
        echo "CHART_SKIP: chart script not found"
        exit 0
      fi

      node -e "
        const fs = require('fs');
        const analysis = JSON.parse(fs.readFileSync('/tmp/lb_chart_analysis.json', 'utf8').trim());
        const markets = analysis.markets || [];
        
        const chartData = markets.slice(0, 10).map(m => {
          let label = m.question.replace(/\\?$/, '');
          if (label.length > 25) {
            const dateMatch = label.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\\s+\\d{1,2}/i);
            const actionMatch = label.match(/^(US strikes|Israel strikes|US x Iran|Khamenei)/i);
            if (dateMatch && actionMatch) {
              label = actionMatch[1].replace('strikes', 'strike') + '\\n' + dateMatch[0];
            } else if (label.length > 30) {
              label = label.slice(0, 27) + '...';
            }
          }
          return { x: label, y: m.yes_pct };
        });
        console.log(JSON.stringify(chartData));
      " > /tmp/pm_chart_data.json
      
      rm -f /tmp/lb_chart_analysis.json
      
      if [ "$(cat /tmp/pm_chart_data.json)" = "[]" ]; then
        echo "CHART_SKIP: no data"
        rm -f /tmp/pm_chart_data.json
        exit 0
      fi

      hour=$(date -u +%H)
      israel_hour=$((hour + 2))
      [ $israel_hour -ge 24 ] && israel_hour=$((israel_hour - 24))
      dark_flag=""
      if [ $israel_hour -ge 20 ] || [ $israel_hour -lt 7 ]; then
        dark_flag="--dark"
      fi

      node "$CHART_SCRIPT" \
        --type bar \
        --data "$(cat /tmp/pm_chart_data.json)" \
        --title "$CHART_TITLE" \
        --y-title "% Probability" \
        --y-domain "0,100" \
        --show-values \
        $dark_flag \
        --width 850 --height 420 \
        --output "$CHART_OUTPUT" 2>&1

      rm -f /tmp/pm_chart_data.json
      echo "CHART_FILE:$CHART_OUTPUT"

  - id: osint-check
    command: |
      query="${osint_query}"
      script="${osint_script}"
      if [ -n "$query" ] && [ -f "$script" ]; then
        node "$script" --days 1 --compact "$query" 2>/dev/null | head -c 1500
      else
        echo ""
      fi

  - id: report
    command: |
      cat > /tmp/lb_final_analysis.json << 'ANALYSIS_EOF'
      $save-state.stdout
      ANALYSIS_EOF
      
      cat > /tmp/lb_osint.txt << 'OSINT_EOF'
      $osint-check.stdout
      OSINT_EOF
      
      cat > /tmp/lb_chart.txt << 'CHART_EOF'
      $generate-chart.stdout
      CHART_EOF

      node -e "
        const fs = require('fs');
        const analysis = JSON.parse(fs.readFileSync('/tmp/lb_final_analysis.json', 'utf8').trim());
        const osint = fs.readFileSync('/tmp/lb_osint.txt', 'utf8').trim();
        const chartResult = fs.readFileSync('/tmp/lb_chart.txt', 'utf8').trim();

        let out = [];

        if (analysis.any_significant) {
          out.push('ğŸš¨ **PREDICTION MARKET ALERT â€” Significant Move!**');
        } else {
          out.push('ğŸ“Š **Prediction Market Update**');
        }
        out.push('âš™ï¸  Threshold: Â±' + analysis.threshold + '% | Markets tracked: ' + analysis.total_count);

        const chartMatch = chartResult.match(/CHART_FILE:(.+)/);
        if (chartMatch) {
          out.push('');
          out.push('CHART_FILE:' + chartMatch[1]);
        }

        if (analysis.any_significant) {
          out.push('');
          out.push('**ğŸ“ˆ Significant Moves:**');
          analysis.markets.filter(m => m.significant).forEach(m => {
            const arrow = m.delta > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
            const sign = m.delta > 0 ? '+' : '';
            out.push(arrow + ' **' + m.last_pct + '% â†’ ' + m.yes_pct + '%** (' + sign + m.delta.toFixed(1) + '%)');
            out.push('   ' + m.question);
          });
        }

        out.push('');
        out.push('**ğŸ“‹ All Tracked Markets:**');
        analysis.markets.slice(0, 10).forEach(m => {
          const q = m.question.length > 65 ? m.question.slice(0, 62) + '...' : m.question;
          out.push('â€¢ **' + m.yes_pct + '%** â€” ' + q);
        });

        if (osint && osint.length > 30) {
          out.push('');
          out.push('**ğŸ” OSINT (X):**');
          out.push(osint.slice(0, 1200));
        }

        console.log(out.join('\\n'));
      "
      rm -f /tmp/lb_final_analysis.json /tmp/lb_osint.txt /tmp/lb_chart.txt
