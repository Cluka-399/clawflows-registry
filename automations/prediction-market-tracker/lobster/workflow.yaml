# Lobster workflow: prediction-market-tracker
# Monitor Polymarket prediction markets by topic keywords, alert on significant moves
# Now with historical trend tracking and line charts!
#
# Usage:
#   lobster run --file workflow.yaml
#   lobster run --file workflow.yaml --args-json '{"keywords":"iran,strike","alert_threshold":"3"}'
#
# Requires: curl, node
#
# APIs used:
#   - gamma-api.polymarket.com (Polymarket markets, no auth needed)

name: prediction-market-tracker
description: Monitor Polymarket prediction markets by topic, alert on significant probability changes with trend charts

args:
  keywords:
    description: "Comma-separated keywords to filter markets (case-insensitive, matches any)"
    default: "strike,attack,military,war"
  exclude_keywords:
    description: "Comma-separated keywords to exclude markets"
    default: ""
  alert_threshold:
    description: "Alert if probability changes more than this percentage since last check"
    default: "3"
  state_file:
    description: "Path to state file for tracking probability history"
    default: "/tmp/clawflows-prediction-market-state.json"
  chart_output:
    description: "Path for generated bar chart image"
    default: "/tmp/prediction-market-chart.png"
  trend_chart_output:
    description: "Path for generated trend line chart"
    default: "/tmp/prediction-market-trends.png"
  chart_title:
    description: "Title for the bar chart"
    default: "Prediction Markets â€” Polymarket"
  osint_query:
    description: "Optional X/Twitter search query for cross-referencing (empty = skip)"
    default: ""
  osint_script:
    description: "Path to X search script"
    default: "/data/skills/search-x/scripts/search.js"
  chart_script:
    description: "Path to chart-image script"
    default: "/data/clawd/skills/chart-image/scripts/chart.mjs"
  history_days:
    description: "Number of days of history to retain"
    default: "7"

steps:
  - id: fetch-markets
    command: |
      tmpf=$(mktemp)
      curl -sf --max-time 20 \
        "https://gamma-api.polymarket.com/markets?active=true&closed=false&limit=200&order=volume24hr&ascending=false" \
        -o "$tmpf" 2>/dev/null
      if [ -s "$tmpf" ]; then
        cat "$tmpf"
      else
        echo '[]'
      fi
      rm -f "$tmpf"

  - id: filter-markets
    stdin: $fetch-markets.stdout
    command: |
      cat > /tmp/lb_pm_raw.json
      KW="${keywords}"
      EX="${exclude_keywords}"
      
      node -e "
        const fs = require('fs');
        const data = JSON.parse(fs.readFileSync('/tmp/lb_pm_raw.json', 'utf8'));
        const include = '$KW'.toLowerCase().split(',').map(s => s.trim()).filter(Boolean);
        const exclude = '$EX' ? '$EX'.toLowerCase().split(',').map(s => s.trim()).filter(Boolean) : [];

        const results = data.filter(m => {
          const q = (m.question || '').toLowerCase();
          const matchesInclude = include.some(kw => new RegExp('\\\\b' + kw + '\\\\b').test(q));
          const matchesExclude = exclude.length > 0 && exclude.some(kw => new RegExp('\\\\b' + kw + '\\\\b').test(q));
          return matchesInclude && !matchesExclude;
        }).map(m => {
          const prices = JSON.parse(m.outcomePrices || '[]');
          const yesPct = Math.round(parseFloat(prices[0] || 0) * 10000) / 100;
          return {
            question: m.question,
            yes_pct: yesPct,
            volume: m.volumeNum || 0,
            slug: m.slug
          };
        }).sort((a, b) => b.yes_pct - a.yes_pct);

        console.log(JSON.stringify(results));
      "
      rm -f /tmp/lb_pm_raw.json

  - id: load-state
    command: |
      cat "${state_file}" 2>/dev/null || echo '{}'

  - id: analyze-and-save
    command: |
      cat > /tmp/lb_markets.json << 'MARKETS_EOF'
      $filter-markets.stdout
      MARKETS_EOF
      
      cat > /tmp/lb_state.json << 'STATE_EOF'
      $load-state.stdout
      STATE_EOF
      
      THRESH="${alert_threshold}"
      STATE_FILE="${state_file}"
      HISTORY_DAYS="${history_days}"

      node -e "
        const fs = require('fs');
        const markets = JSON.parse(fs.readFileSync('/tmp/lb_markets.json', 'utf8').trim());
        let state = {};
        try {
          state = JSON.parse(fs.readFileSync('/tmp/lb_state.json', 'utf8').trim());
        } catch(e) {}
        
        const thresh = parseFloat('$THRESH' || '3');
        const historyDays = parseInt('$HISTORY_DAYS' || '7');
        const now = new Date();
        const cutoff = new Date(now - historyDays * 24 * 60 * 60 * 1000);

        // Analyze markets and update state with history
        const analyzed = markets.map(m => {
          // Get or create market state
          if (!state[m.slug]) {
            state[m.slug] = { history: [], question: m.question };
          }
          
          const mktState = state[m.slug];
          mktState.question = m.question; // Keep question updated
          
          // Get last recorded pct
          const lastEntry = mktState.history[mktState.history.length - 1];
          const lastPct = lastEntry ? lastEntry.pct : null;
          
          // Add new data point
          mktState.history.push({ t: now.toISOString(), pct: m.yes_pct });
          
          // Prune old history
          mktState.history = mktState.history.filter(h => new Date(h.t) > cutoff);
          
          const delta = lastPct != null ? m.yes_pct - lastPct : null;
          return {
            ...m,
            last_pct: lastPct || m.yes_pct,
            delta: delta || 0,
            significant: delta != null && Math.abs(delta) >= thresh,
            first_run: lastPct == null,
            history: mktState.history
          };
        });

        // Save updated state
        fs.writeFileSync('$STATE_FILE', JSON.stringify(state, null, 2));

        const result = {
          markets: analyzed,
          any_significant: analyzed.some(m => m.significant),
          significant_count: analyzed.filter(m => m.significant).length,
          total_count: analyzed.length,
          threshold: thresh
        };
        console.log(JSON.stringify(result));
      "
      rm -f /tmp/lb_markets.json /tmp/lb_state.json

  - id: generate-bar-chart
    command: |
      cat > /tmp/lb_chart_analysis.json << 'ANALYSIS_EOF'
      $analyze-and-save.stdout
      ANALYSIS_EOF
      
      CHART_SCRIPT="${chart_script}"
      CHART_OUTPUT="${chart_output}"
      CHART_TITLE="${chart_title}"

      if [ ! -f "$CHART_SCRIPT" ]; then
        echo "CHART_SKIP: chart script not found"
        exit 0
      fi

      node -e "
        const fs = require('fs');
        const analysis = JSON.parse(fs.readFileSync('/tmp/lb_chart_analysis.json', 'utf8').trim());
        const markets = analysis.markets || [];
        
        const chartData = markets.slice(0, 10).map(m => {
          let label = m.question.replace(/\\?$/, '');
          if (label.length > 25) {
            const dateMatch = label.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\\s+\\d{1,2}/i);
            const actionMatch = label.match(/^(US strikes|Israel strikes|US x Iran|Khamenei)/i);
            if (dateMatch && actionMatch) {
              label = actionMatch[1].replace('strikes', 'strike') + '\\n' + dateMatch[0];
            } else if (label.length > 30) {
              label = label.slice(0, 27) + '...';
            }
          }
          return { x: label, y: m.yes_pct };
        });
        console.log(JSON.stringify(chartData));
      " > /tmp/pm_chart_data.json
      
      if [ "$(cat /tmp/pm_chart_data.json)" = "[]" ]; then
        echo "BAR_CHART_SKIP: no data"
        rm -f /tmp/pm_chart_data.json /tmp/lb_chart_analysis.json
        exit 0
      fi

      hour=$(date -u +%H)
      israel_hour=$((hour + 2))
      [ $israel_hour -ge 24 ] && israel_hour=$((israel_hour - 24))
      dark_flag=""
      if [ $israel_hour -ge 20 ] || [ $israel_hour -lt 7 ]; then
        dark_flag="--dark"
      fi

      node "$CHART_SCRIPT" \
        --type bar \
        --data "$(cat /tmp/pm_chart_data.json)" \
        --title "$CHART_TITLE" \
        --y-title "% Probability" \
        --y-domain "0,100" \
        --show-values \
        $dark_flag \
        --width 850 --height 420 \
        --output "$CHART_OUTPUT" 2>&1

      rm -f /tmp/pm_chart_data.json /tmp/lb_chart_analysis.json
      echo "BAR_CHART:$CHART_OUTPUT"

  - id: generate-trend-chart
    command: |
      cat > /tmp/lb_trend_analysis.json << 'ANALYSIS_EOF'
      $analyze-and-save.stdout
      ANALYSIS_EOF
      
      CHART_SCRIPT="${chart_script}"
      TREND_OUTPUT="${trend_chart_output}"

      if [ ! -f "$CHART_SCRIPT" ]; then
        echo "TREND_SKIP: chart script not found"
        exit 0
      fi

      node -e "
        const fs = require('fs');
        const analysis = JSON.parse(fs.readFileSync('/tmp/lb_trend_analysis.json', 'utf8').trim());
        const markets = analysis.markets || [];
        
        // Pick top markets by volume/interest that have enough history
        const withHistory = markets
          .filter(m => m.history && m.history.length >= 2)
          .slice(0, 6); // Top 6 markets
        
        if (withHistory.length === 0) {
          console.log('TREND_SKIP: not enough history yet');
          process.exit(0);
        }

        // Build multi-series data for line chart
        // Format: [{x: timestamp, series1: val, series2: val, ...}]
        
        // Collect all unique timestamps
        const allTimes = new Set();
        withHistory.forEach(m => m.history.forEach(h => allTimes.add(h.t)));
        const sortedTimes = Array.from(allTimes).sort();
        
        // Create short labels for series
        const seriesLabels = withHistory.map(m => {
          const q = m.question;
          // Extract key identifier
          const dateMatch = q.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\\s+\\d{1,2}/i);
          const actionMatch = q.match(/^(US strikes|Israel strikes|US x Iran|Khamenei|meeting)/i);
          if (dateMatch && actionMatch) {
            return (actionMatch[1].replace('strikes', 'â†’') + ' ' + dateMatch[0]).slice(0, 20);
          }
          if (q.includes('Oman')) return 'Oman meeting';
          return q.slice(0, 18) + (q.length > 18 ? 'â€¦' : '');
        });

        // Build data points - interpolate missing values
        const chartData = sortedTimes.map(t => {
          const point = { x: t };
          withHistory.forEach((m, i) => {
            const entry = m.history.find(h => h.t === t);
            if (entry) {
              point[seriesLabels[i]] = entry.pct;
            } else {
              // Find closest earlier value
              const earlier = m.history.filter(h => h.t < t).sort((a,b) => b.t.localeCompare(a.t))[0];
              if (earlier) point[seriesLabels[i]] = earlier.pct;
            }
          });
          return point;
        });

        // Output as JSON for chart script
        console.log(JSON.stringify({
          data: chartData,
          series: seriesLabels
        }));
      " > /tmp/trend_prep.json
      
      rm -f /tmp/lb_trend_analysis.json

      prep=$(cat /tmp/trend_prep.json)
      if echo "$prep" | grep -q "TREND_SKIP"; then
        echo "$prep"
        rm -f /tmp/trend_prep.json
        exit 0
      fi

      hour=$(date -u +%H)
      israel_hour=$((hour + 2))
      [ $israel_hour -ge 24 ] && israel_hour=$((israel_hour - 24))
      dark_flag=""
      if [ $israel_hour -ge 20 ] || [ $israel_hour -lt 7 ]; then
        dark_flag="--dark"
      fi

      # Extract data array for chart
      data=$(echo "$prep" | node -e "const d=require('fs').readFileSync(0,'utf8');console.log(JSON.stringify(JSON.parse(d).data))")
      
      node "$CHART_SCRIPT" \
        --type line \
        --data "$data" \
        --title "Probability Trends Over Time" \
        --y-title "% Probability" \
        --y-domain "0,100" \
        --x-type "time" \
        $dark_flag \
        --width 950 --height 500 \
        --output "$TREND_OUTPUT" 2>&1

      rm -f /tmp/trend_prep.json
      echo "TREND_CHART:$TREND_OUTPUT"

  - id: osint-check
    command: |
      query="${osint_query}"
      script="${osint_script}"
      if [ -n "$query" ] && [ -f "$script" ]; then
        node "$script" --days 1 --compact "$query" 2>/dev/null | head -c 1500
      else
        echo ""
      fi

  - id: report
    command: |
      cat > /tmp/lb_final_analysis.json << 'ANALYSIS_EOF'
      $analyze-and-save.stdout
      ANALYSIS_EOF
      
      cat > /tmp/lb_osint.txt << 'OSINT_EOF'
      $osint-check.stdout
      OSINT_EOF
      
      cat > /tmp/lb_bar_chart.txt << 'CHART_EOF'
      $generate-bar-chart.stdout
      CHART_EOF

      cat > /tmp/lb_trend_chart.txt << 'TREND_EOF'
      $generate-trend-chart.stdout
      TREND_EOF

      node -e "
        const fs = require('fs');
        const analysis = JSON.parse(fs.readFileSync('/tmp/lb_final_analysis.json', 'utf8').trim());
        const osint = fs.readFileSync('/tmp/lb_osint.txt', 'utf8').trim();
        const barChartResult = fs.readFileSync('/tmp/lb_bar_chart.txt', 'utf8').trim();
        const trendChartResult = fs.readFileSync('/tmp/lb_trend_chart.txt', 'utf8').trim();

        let out = [];

        if (analysis.any_significant) {
          out.push('ğŸš¨ **PREDICTION MARKET ALERT â€” Significant Moves Detected!**');
        } else {
          out.push('ğŸ“Š **Prediction Market Update**');
        }
        out.push('âš™ï¸ Threshold: Â±' + analysis.threshold + '% | Markets tracked: ' + analysis.total_count);

        // Bar chart path
        const barMatch = barChartResult.match(/BAR_CHART:(.+)/);
        if (barMatch) {
          out.push('');
          out.push('BAR_CHART:' + barMatch[1]);
        }

        // Trend chart path
        const trendMatch = trendChartResult.match(/TREND_CHART:(.+)/);
        if (trendMatch) {
          out.push('');
          out.push('TREND_CHART:' + trendMatch[1]);
        }

        if (analysis.any_significant) {
          out.push('');
          out.push('**ğŸ“ˆ Significant Moves Since Last Check:**');
          analysis.markets.filter(m => m.significant).forEach(m => {
            const arrow = m.delta > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
            const sign = m.delta > 0 ? '+' : '';
            out.push('â€¢ **' + m.last_pct + '% â†’ ' + m.yes_pct + '%** (' + sign + m.delta.toFixed(1) + '%) â€” ' + m.question);
          });
        }

        out.push('');
        out.push('**ğŸ“‹ Top Markets:**');
        analysis.markets.slice(0, 10).forEach(m => {
          const q = m.question.length > 50 ? m.question.slice(0, 47) + '...' : m.question;
          out.push('â€¢ **' + m.yes_pct + '%** â€” ' + q);
        });

        if (osint && osint.length > 30) {
          out.push('');
          out.push('**ğŸ” OSINT (X):**');
          out.push(osint.slice(0, 1200));
        }

        console.log(out.join('\\n'));
      "
      rm -f /tmp/lb_final_analysis.json /tmp/lb_osint.txt /tmp/lb_bar_chart.txt /tmp/lb_trend_chart.txt
